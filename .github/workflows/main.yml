name: Main Workflow

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch all history for detecting changes

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        cache-disabled: true

    - name: Build with Gradle
      run: ./gradlew build -x test

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v41
      with:
        since_last_remote_commit: true

    - name: Determine which lessons were changed
      id: determine-lessons
      run: |
        LESSONS=""

        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          if [[ $file == src/*/kotlin/com/motycka/edu/lesson01/* ]]; then
            LESSONS="${LESSONS}01 "
          elif [[ $file == src/*/kotlin/com/motycka/edu/lesson02/* ]]; then
            LESSONS="${LESSONS}02 "
          elif [[ $file == src/*/kotlin/com/motycka/edu/lesson03/* ]]; then
            LESSONS="${LESSONS}03 "
          elif [[ $file == src/*/kotlin/com/motycka/edu/lesson04/* ]]; then
            LESSONS="${LESSONS}04 "
          fi
        done

        # Remove duplicates and trailing space
        LESSONS=$(echo $LESSONS | tr ' ' '\n' | sort -u | tr '\n' ' ' | xargs)
        echo "lessons=$LESSONS" >> $GITHUB_OUTPUT
        echo "Lessons changed: $LESSONS"

    - name: Run tests for changed lessons
      if: steps.determine-lessons.outputs.lessons != ''
      run: |
        LESSONS="${{ steps.determine-lessons.outputs.lessons }}"
        for lesson in $LESSONS; do
          echo "Running tests for Lesson $lesson"
          ./gradlew testLesson$lesson
        done
